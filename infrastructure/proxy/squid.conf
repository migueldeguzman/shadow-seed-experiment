# =============================================================
# Lab Room Proxy â€” Squid Configuration
# Purpose: Allow public internet, block all private/local IPs
# Author: Mia ðŸŒ¸ | Date: 2026-02-15
# =============================================================

# --- Port ---
http_port 3128

# --- ACL: Define private/local IP ranges (BLOCK these as destinations) ---
acl local_dst dst 10.0.0.0/8
acl local_dst dst 172.16.0.0/12
acl local_dst dst 192.168.0.0/16
acl local_dst dst 169.254.0.0/16
acl local_dst dst 127.0.0.0/8
acl local_dst dst 0.0.0.0/8
acl local_dst dst fc00::/7
acl local_dst dst ::1/128

# --- ACL: Standard port definitions ---
acl SSL_ports port 443
acl Safe_ports port 80        # http
acl Safe_ports port 443       # https
acl Safe_ports port 1025-65535  # high ports (APIs, etc.)
acl CONNECT method CONNECT

# --- Access Rules (ORDER MATTERS) ---

# Block non-safe ports
http_access deny !Safe_ports

# Block CONNECT to non-SSL ports
http_access deny CONNECT !SSL_ports

# CRITICAL: Block ALL traffic to private/local destinations
http_access deny local_dst

# Allow everything else (public internet)
http_access allow all

# --- DNS ---
# Squid resolves DNS itself â€” prevents DNS rebinding attacks
# Subject asks proxy for "evil.com" â†’ Squid resolves it â†’ checks dest IP â†’ blocks if private
dns_nameservers 8.8.8.8 8.8.4.4

# --- Logging ---
# Structured access log â€” every request recorded
access_log stdio:/var/log/squid/access.log combined
cache_log stdio:/var/log/squid/cache.log

# --- Performance ---
# No caching â€” we want subjects to hit real servers
cache deny all

# --- Security Hardening ---
# Don't reveal we're running Squid
via off
forwarded_for delete
request_header_access X-Forwarded-For deny all

# Run as unprivileged
cache_effective_user proxy
cache_effective_group proxy

# --- Timeouts ---
connect_timeout 30 seconds
read_timeout 120 seconds
request_timeout 120 seconds

# Shutdown quickly
shutdown_lifetime 3 seconds

# PID file
pid_filename /var/run/squid/squid.pid

# Coredumps off
coredump_dir /var/spool/squid
