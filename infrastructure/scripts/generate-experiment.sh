#!/bin/bash
# =============================================================
# Lab Protocol ‚Äî Experiment Generator
# Reads config.json and generates docker-compose, scripts, cron
#
# Usage:
#   ./generate-experiment.sh <experiment-id>
#   ./generate-experiment.sh rsi-002
#
# Author: Mia üå∏ | Date: 2026-02-15
# =============================================================

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
LAB_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"
EXP_ID="${1:?Usage: generate-experiment.sh <experiment-id>}"
EXP_DIR="$LAB_DIR/experiments/$EXP_ID"
CONFIG="$EXP_DIR/config.json"

if [ ! -f "$CONFIG" ]; then
  echo "‚ùå Config not found: $CONFIG"
  echo "   Create it first, or copy from TEMPLATE"
  exit 1
fi

echo "üß™ Generating experiment: $EXP_ID"
echo "   Config: $CONFIG"
echo ""

# Parse config with python
python3 - "$CONFIG" "$EXP_DIR" "$LAB_DIR" <<'PYTHON'
import json, sys, os

config_path = sys.argv[1]
exp_dir = sys.argv[2]
lab_dir = sys.argv[3]

with open(config_path) as f:
    config = json.load(f)

exp = config["experiment"]
subj = config["subjects"]
seeds = config["seeds"]
sched = config["schedule"]
prompts = config["prompts"]
infra = config.get("infrastructure", {})

pairs = subj["pairs"]
names = subj.get("names", ["John"])
prefix = infra.get("containerPrefix", "lab-")
subnet_base = 201  # 10.201.0.0/24, 10.202.0.0/24, etc.

# Determine subject naming
def get_name(pair_idx):
    """Get the name for a given pair (0-indexed)."""
    return names[pair_idx % len(names)]

def get_subject_id(group, pair_num, name):
    """Generate subject ID like john-a-1 or alice-a-1."""
    return f"{name.lower()}-{group}-{pair_num}"

# Generate subject list
all_subjects = []
for i in range(pairs):
    pair_num = i + 1
    name = get_name(i)
    all_subjects.append({
        "id": get_subject_id("a", pair_num, name),
        "group": "a",
        "pair": pair_num,
        "name": name,
        "treatment": True
    })
    all_subjects.append({
        "id": get_subject_id("b", pair_num, name),
        "group": "b",
        "pair": pair_num,
        "name": name,
        "treatment": False
    })

print(f"üìã Experiment: {exp['id']} ‚Äî {exp['name']}")
print(f"   Pairs: {pairs}")
print(f"   Names: {', '.join(names)}")
print(f"   Subjects: {len(all_subjects)}")
print(f"   Sessions/day: {sched['sessionsPerDay']}")
print(f"   Model: {subj['model']}")
print()

# --- Generate trigger script ---
trigger_path = os.path.join(exp_dir, "trigger-session.sh")
all_ids = [s["id"] for s in all_subjects]
shadow_ids = [s["id"] for s in all_subjects if s["treatment"]]
control_ids = [s["id"] for s in all_subjects if not s["treatment"]]

prompt = prompts.get("selfImprovement", "Reflect on yourself.")

trigger_script = f'''#!/bin/bash
# Auto-generated trigger script for {exp["id"]}
# Pairs: {pairs} | Subjects: {len(all_subjects)} | Generated by generate-experiment.sh

set -e
TIMESTAMP=$(date -u +%Y%m%d-%H%M%S)
ALL_SUBJECTS=({" ".join(f'"{s}"' for s in all_ids)})
SHADOW_SUBJECTS=({" ".join(f'"{s}"' for s in shadow_ids)})
CONTROL_SUBJECTS=({" ".join(f'"{s}"' for s in control_ids)})
TARGETS=()

PROMPT='{prompt}'

if [ $# -eq 0 ]; then
  TARGETS=("${{ALL_SUBJECTS[@]}}")
elif [ "$1" = "--pair" ]; then
  P="$2"
  TARGETS=("{get_subject_id("a", "$P", names[0]).replace("$P", "${P}")}" "{get_subject_id("b", "$P", names[0]).replace("$P", "${P}")}")
elif [ "$1" = "--shadow" ] || [ "$1" = "--treatment" ]; then
  TARGETS=("${{SHADOW_SUBJECTS[@]}}")
elif [ "$1" = "--control" ]; then
  TARGETS=("${{CONTROL_SUBJECTS[@]}}")
else
  TARGETS=("$1")
fi

echo "üß™ {exp["id"]} ‚Äî Self-Improvement Trigger (N={pairs})"
echo "=================================================="
echo "Time: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
echo "Targets: ${{TARGETS[*]}}"
echo ""

trigger_subject() {{
  local SUBJECT="$1"
  local CONTAINER="{prefix}${{SUBJECT}}"
  local LOGFILE="/workspace/logs/session-${{TIMESTAMP}}.md"

  if ! docker ps --format '{{{{.Names}}}}' | grep -q "^${{CONTAINER}}$"; then
    echo "  ‚ùå ${{SUBJECT}}: container not running"
    return 1
  fi

  docker exec -d "$CONTAINER" bash -c "
    cd /workspace && \\
    claude --print '$PROMPT' 2>&1 | tee '$LOGFILE' && \\
    echo '--- Session complete: \\$(date -u +%Y-%m-%dT%H:%M:%SZ) ---' >> '$LOGFILE'
  "
  echo "  ‚úÖ ${{SUBJECT}}: session started"
}}

for SUBJ in "${{TARGETS[@]}}"; do
  trigger_subject "$SUBJ"
done

echo ""
echo "‚úÖ ${{#TARGETS[@]}} session(s) triggered at $TIMESTAMP"
'''

with open(trigger_path, "w") as f:
    f.write(trigger_script)
os.chmod(trigger_path, 0o755)
print(f"‚úÖ Generated: {trigger_path}")

# --- Generate cron schedule summary ---
cron_path = os.path.join(exp_dir, "cron-schedule.md")
tz = sched.get("timezone", "UTC")
lines = [f"# {exp['id']} Cron Schedule\n"]
lines.append(f"Timezone: {tz}\n")
lines.append(f"Sessions per day: {sched['sessionsPerDay']}\n")
lines.append(f"Subjects per session: {len(all_subjects)}\n")
lines.append(f"Total sessions/day: {sched['sessionsPerDay'] * len(all_subjects)}\n\n")
lines.append("| Session | Trigger | Analysis | Cron (trigger) | Cron (analysis) |\n")
lines.append("|---------|---------|----------|----------------|------------------|\n")
for sess in sched["sessions"]:
    th, tm = sess["triggerTime"].split(":")
    ah, am = sess["analysisTime"].split(":")
    lines.append(f"| {sess['name']} | {sess['triggerTime']} | {sess['analysisTime']} | `{tm} {th} * * *` | `{am} {ah} * * *` |\n")

with open(cron_path, "w") as f:
    f.writelines(lines)
print(f"‚úÖ Generated: {cron_path}")

# --- Generate subject manifest ---
manifest_path = os.path.join(exp_dir, "subjects-manifest.json")
manifest = {
    "experiment": exp["id"],
    "generatedAt": "auto",
    "pairs": pairs,
    "totalSubjects": len(all_subjects),
    "model": subj["model"],
    "subjects": all_subjects
}
with open(manifest_path, "w") as f:
    json.dump(manifest, f, indent=2)
print(f"‚úÖ Generated: {manifest_path}")

print(f"\nüéâ Experiment {exp['id']} generated successfully!")
print(f"   {len(all_subjects)} subjects across {pairs} pairs")
print(f"   {sched['sessionsPerDay']} sessions/day = {sched['sessionsPerDay'] * len(all_subjects)} total sessions/day")
PYTHON

echo ""
echo "Next steps:"
echo "  1. Review generated files in $EXP_DIR/"
echo "  2. Generate docker-compose if needed"
echo "  3. Set up cron jobs via MiaBot"
echo "  4. Launch!"
